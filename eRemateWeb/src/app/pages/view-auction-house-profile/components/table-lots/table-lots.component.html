<div class="table-container" style="width: 1040px; margin: 0 auto; margin-bottom: 40px;">
  <div *ngIf="loading" class="flex justify-content-center my-3">
    <p-progressSpinner strokeWidth="4" [style]="{'width': '50px', 'height': '50px'}" />
  </div>

  <p-table
    #dt
    [value]="lots"
    [rows]="5"
    [columns]="cols"
    [paginator]="lots.length > 0"
    [globalFilterFields]="globalFilterFields"
    [tableStyle]="{ width: '100%', marginBottom: '1rem' }"
    [(selection)]="selectedLots"
    [rowHover]="true"
    dataKey="id"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} elementos"
    [showCurrentPageReport]="lots.length > 0"
    [loading]="loading"
  >
    <ng-template pTemplate="caption">
      <div class="flex items-center" style="gap: 10px;">
        <!-- Barra de búsqueda -->
        <p-iconfield>
            <p-inputicon styleClass="pi pi-search" />
            <input pInputText type="text" (input)="onFilterGlobal($event)" placeholder="Buscar..." />
        </p-iconfield>
        
        <!-- Botón para agregar lote con color verde -->
        <p-button 
            label="Agregar Lote" 
            icon="pi pi-plus" 
            class="mr-2" 
            (onClick)="openNew()" 
            [style]="{'background-color': '#22C55E', 'border-color': '#22C55E'}" 
        />
        
     
        <p-button 
            label="Artículos del Lote" 
            icon="pi pi-list" 
            [disabled]="!selectedLots || selectedLots.length !== 1"
            (onClick)="openArticlesDialog()" 
            [style]="{'background-color': '#3B82F6', 'border-color': '#3B82F6'}" 
        />
      </div>
    </ng-template>
    
    <ng-template pTemplate="header">
      <tr style="background-color: rgba(0, 0, 0, 0.04);">
        <th style="width: 5%; background-color: rgba(0, 0, 0, 0.04);">
          <p-tableHeaderCheckbox />
        </th>
        <th *ngFor="let col of cols" [style.width]="'calc(84% / ' + cols.length + ')'" style="background-color: rgba(0, 0, 0, 0.04);">
          {{ col.header }}
        </th>
        <th style="width: 11%; background-color: rgba(0, 0, 0, 0.04);">Acciones</th>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="body" let-lot>
      <tr>
        <td style="width: 5%">
          <p-tableCheckbox [value]="lot" />
        </td>
        
        <td [style.width]="'calc(84% / ' + cols.length + ')'" *ngFor="let col of cols">
          <span *ngIf="col.field === 'valorBase' || col.field === 'incrementoMinimo'">
            {{ formatCurrency(lot[col.field]) }}
          </span>
          <span *ngIf="col.field !== 'valorBase' && col.field !== 'incrementoMinimo'">
            {{ lot[col.field] }}
          </span>
        </td>
        
        <td style="width: 11%">
          <div class="flex gap-2 justify-center">
            <p-button icon="pi pi-list" severity="info" [rounded]="true" [outlined]="true" (click)="editArticlesForLot(lot)" pTooltip="Editar artículos" />
            <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deleteLot(lot)" pTooltip="Eliminar lote" />
          </div>
        </td>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="text-center p-4">
          No hay lotes disponibles
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Modal de Lote (sin la sección de artículos) -->
  <p-dialog [(visible)]="lotDialog" [style]="{ width: '700px' }" header="Detalles del Lote" [modal]="true">
    <ng-template pTemplate="content">
      <div class="flex flex-col gap-4">
        <!-- Datos básicos del lote -->
        <div>
          <h3 class="text-xl font-semibold mb-3">Información del lote</h3>
          
          <!-- Campos existentes -->
          <div>
            <label for="subasta" class="block font-bold mb-2">Subasta</label>
            <input type="text" pInputText id="subasta" [value]="auctionId" disabled class="w-full" />
          </div>
          
          <div class="mt-3">
            <label for="lote" class="block font-bold mb-2">Nombre del Lote</label>
            <input type="text" pInputText id="lote" [(ngModel)]="lot.lote" required autofocus class="w-full" />
            <small class="text-red-500" *ngIf="submitted && !lot.lote?.trim()">El nombre del lote es requerido.</small>
          </div>
          
          <div class="mt-3">
            <label for="vendedorExterno" class="block font-bold mb-2">Vendedor Externo</label>
            <input type="text" pInputText id="vendedorExterno" [(ngModel)]="lot.vendedorExterno" class="w-full" />
          </div>
          
          <div class="mt-3">
            <label for="valorBase" class="block font-bold mb-2">Valor Base ($)</label>
            <p-inputNumber id="valorBase" [(ngModel)]="lot.valorBase" mode="currency" currency="UYU" 
              locale="es-UY" [minFractionDigits]="0" class="w-full" />
          </div>
          
          <div class="mt-3">
            <label for="incrementoMinimo" class="block font-bold mb-2">Incremento Mínimo ($)</label>
            <p-inputNumber id="incrementoMinimo" [(ngModel)]="lot.incrementoMinimo" mode="currency" 
              currency="UYU" locale="es-UY" [minFractionDigits]="0" class="w-full" />
          </div>
          
          <!-- Nuevo campo Condiciones de Entrega -->
          <div class="mt-3">
            <label for="condicionesEntrega" class="block font-bold mb-2">Condiciones de Entrega</label>
            <textarea pInputTextarea id="condicionesEntrega" [(ngModel)]="lot.condicionesEntrega" rows="3" class="w-full"></textarea>
          </div>
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <div class="flex justify-content-end gap-2">
        <p-button 
            label="Cancelar" 
            icon="pi pi-times" 
            (onClick)="hideDialog()" 
            [style]="{'background-color': '#000000', 'border-color': '#000000', 'color': '#FFFFFF'}" 
        />
        <p-button 
            label="Guardar" 
            icon="pi pi-check" 
            (onClick)="saveLot()" 
            [style]="{'background-color': '#6334E3', 'border-color': '#6334E3'}" 
        />
      </div>
    </ng-template>
  </p-dialog>

  <p-confirmDialog [style]="{ width: '450px' }" />

  <!-- Modal para gestionar artículos del lote -->
  <p-dialog [(visible)]="articlesManagementDialog" [style]="{ width: '800px' }" [header]="'Artículos del Lote: ' + (selectedLotForArticles?.lote || '')" [modal]="true">
    <ng-template pTemplate="content">
      <div class="flex flex-col gap-4">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-xl font-semibold">Artículos</h3>
          <p-button 
              icon="pi pi-plus" 
              label="Agregar Artículo" 
              (click)="addNewArticle()" 
              [style]="{'background-color': '#22C55E', 'border-color': '#22C55E'}" 
          />
        </div>
        
        <div *ngIf="selectedLotForArticles?.articulos " class="mb-4">
          <table class="article-table">
            <thead>
              <tr class="bg-gray-100">
                <th class="border border-gray-300 p-2 text-left">Nombre</th>
                <th class="border border-gray-300 p-2 text-left">Estado</th>
                <th class="border border-gray-300 p-2 text-left">Especificaciones Técnicas</th>
                <th class="border border-gray-300 p-2 text-center" style="width: 100px">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let articulo of selectedLotForArticles?.articulos || []; let i = index" class="border-b border-gray-300">
                <td class="border border-gray-300 p-2">{{articulo.nombre}}</td>
                <td class="border border-gray-300 p-2">{{articulo.estado}}</td>
                <td class="border border-gray-300 p-2">{{articulo.especificacionesTecnicas}}</td>
                <td class="border border-gray-300 p-2 text-center">
                  <div class="flex justify-center gap-2">
                    <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-text" (click)="editArticle(i)"></button>
                    <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-text p-button-danger" (click)="removeArticle(i)"></button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div *ngIf="!selectedLotForArticles?.articulos" class="text-center p-4 bg-gray-100 rounded mb-3">
          No hay artículos agregados. Use el botón "Agregar Artículo" para incluir artículos en este lote.
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <div class="flex justify-content-end gap-2">
        <p-button 
            label="Aceptar" 
            icon="pi pi-check" 
            (onClick)="hideArticlesDialog()" 
            [style]="{'background-color': '#6334E3', 'border-color': '#6334E3'}" 
        />
      </div>
    </ng-template>
  </p-dialog>

  <!-- Diálogo para detalles del artículo (individual) -->
  <p-dialog [(visible)]="articleDialog" [style]="{ width: '500px' }" header="Detalles del Artículo" [modal]="true">
    <app-add-item 
      [articulo]="currentArticle" 
      [submitted]="submittedArticle"
      (save)="saveArticle($event)"
      (cancel)="articleDialog = false">
    </app-add-item>
  </p-dialog>
</div>
